name: Docker Build & Push to Docker Hub

# Auslöser: Startet den Workflow bei jedem Push auf den 'main'-Branch
on:
  push:
    branches:
      - main
  workflow_dispatch:

# Definieren der Umgebungsvariablen für den Image-Namen
env:
  DOCKER_HUB_REPO: ${{ secrets.DOCKER_USERNAME }}/weather-service
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Replace Connection String in appsettings.json
        run: |
          CONNECTION_STRING="${{ secrets.PRODUCTION_CONNECTIONSTRING }}"
          sed -i "s|__DB_CONNECTION_STRING_PLACEHOLDER__|$CONNECTION_STRING|g" CloudComputingAPI/appsettings.Production.json
        env:
          DB_CONNECTION_STRING: ${{ secrets.PRODUCTION_CONNECTIONSTRING }}
          
      - name: Show updated appsettings.json (Optional, zum Debuggen)
        run: cat CloudComputingAPI/appsettings.Production.json

      - name: Set up QEMU (For Multi-Arch Support, optional)
        # Ermöglicht das Bauen von Images für verschiedene Architekturen (z.B. ARM)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        # Notwendig für moderne Docker-Build-Funktionen
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Docker Hub
        # 1. Login bei Docker Hub unter Verwendung der Secrets
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        # 2. Bauen und pushen des Images in einem Schritt
        uses: docker/build-push-action@v5
        with:
          # Context ist der Pfad zum Dockerfile, hier der Root-Ordner (.)
          context: .
          # Pfad zum Dockerfile im Context (hier im Root)
          file: ./Dockerfile 
          # Pushing des Images nach erfolgreichem Build
          push: true
          # Die Images werden mit zwei Tags versehen: dem SHA-Hash (eindeutiger Commit) und 'latest'
          tags: |
            ${{ env.DOCKER_HUB_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_HUB_REPO }}:latest
            
      - name: Image URL anzeigen
        # Zeigt den vollständigen Pfad des gepushten Images zur Bestätigung an
        run: echo "Image erfolgreich gepusht: ${{ env.DOCKER_HUB_REPO }}:${{ env.IMAGE_TAG }}"
